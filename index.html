<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mini GTA 3D</title>
<style>
body{margin:0;overflow:hidden;background:black}
#hud{position:fixed;top:10px;left:10px;color:white;font-family:Arial;font-size:14px;background:rgba(0,0,0,0.5);padding:8px;border-radius:6px}
</style>
</head>
<body>
<div id="hud">‚≠ê Estrellas: <span id="stars">0</span><br>Click para c√°mara ¬∑ WASD mover ¬∑ E coche ¬∑ Q salir</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>
<script>
// ================= ESCENA =================
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);

const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

// ================= LUCES =================
scene.add(new THREE.AmbientLight(0xffffff,0.6));
const sun=new THREE.DirectionalLight(0xffffff,0.8);
sun.position.set(10,20,10);
scene.add(sun);

// ================= SUELO =================
const floor=new THREE.Mesh(
 new THREE.PlaneGeometry(200,200),
 new THREE.MeshStandardMaterial({color:0x2e8b57})
);
floor.rotation.x=-Math.PI/2;
scene.add(floor);

// ================= JUGADOR =================
const player=new THREE.Mesh(
 new THREE.BoxGeometry(1,2,1),
 new THREE.MeshStandardMaterial({color:0x0066ff})
);
player.position.set(0,1,0);
scene.add(player);

let playerVel=new THREE.Vector3();
let keys={};
let stars=0;
let inCar=false;

// ================= EDIFICIOS =================
const buildings=[];
for(let i=0;i<70;i++){
 const h=Math.random()*10+4;
 const b=new THREE.Mesh(
  new THREE.BoxGeometry(4,h,4),
  new THREE.MeshStandardMaterial({color:0x777777})
 );
 b.position.set((Math.random()-0.5)*180,h/2,(Math.random()-0.5)*180);
 b.userData.hitbox=new THREE.Box3().setFromObject(b);
 buildings.push(b);
 scene.add(b);
}

// ================= COCHE =================
const car=new THREE.Mesh(
 new THREE.BoxGeometry(2,1,4),
 new THREE.MeshStandardMaterial({color:0xff0000})
);
car.position.set(5,0.5,5);
scene.add(car);

let carSpeed=0;
let carHealth=100;

// ================= POLIC√çA =================
const police=[];
for(let i=0;i<3;i++){
 const p=new THREE.Mesh(
  new THREE.BoxGeometry(2,1,4),
  new THREE.MeshStandardMaterial({color:0x000000})
 );
 p.position.set(Math.random()*30-15,0.5,Math.random()*30-15);
 police.push(p);
 scene.add(p);
}

// ================= INPUT =================
onkeydown=e=>keys[e.key.toLowerCase()]=true;
onkeyup=e=>keys[e.key.toLowerCase()]=false;

// ================= C√ÅMARA MOUSE =================
let yaw=Math.PI;
let pitch=0;

renderer.domElement.addEventListener("click",()=>renderer.domElement.requestPointerLock());

document.addEventListener("mousemove",e=>{
 if(document.pointerLockElement===renderer.domElement){
  yaw-=e.movementX*0.002;
  pitch-=e.movementY*0.002;
  pitch=Math.max(-1.2,Math.min(1.2,pitch));
 }
});

// ================= HITBOX =================
function playerBox(pos){
 return new THREE.Box3().setFromCenterAndSize(
  new THREE.Vector3(pos.x,1,pos.z),
  new THREE.Vector3(1,2,1)
 );
}
function vehicleBox(pos){
 return new THREE.Box3().setFromCenterAndSize(
  new THREE.Vector3(pos.x,0.5,pos.z),
  new THREE.Vector3(2,1,4)
 );
}
function collide(box){
 for(const b of buildings){
  if(box.intersectsBox(b.userData.hitbox))return true;
 }
 return false;
}

// ================= LOOP =================
function animate(){
 requestAnimationFrame(animate);

 if(!isFinite(yaw)||!isFinite(pitch)){
  yaw=Math.PI;
  pitch=0;
 }

 // --- JUGADOR A PIE ---
 if(!inCar){
  playerVel.set(0,0,0);
  if(keys.w)playerVel.z=-0.15;
  if(keys.s)playerVel.z=0.15;
  if(keys.a)playerVel.x=-0.15;
  if(keys.d)playerVel.x=0.15;
  const next=player.position.clone().add(playerVel);
  if(!collide(playerBox(next)))player.position.copy(next);
 }

 // --- ENTRAR / SALIR COCHE ---
 if(keys.e&&player.position.distanceTo(car.position)<3)inCar=true;
 if(keys.q)inCar=false;

 // --- ROTACI√ìN DEL COCHE ---
 if(inCar)car.rotation.y=yaw;

 // --- COCHE ---
 if(inCar){
  if(keys.w)carSpeed+=0.02;
  if(keys.s)carSpeed-=0.02;
  carSpeed*=0.97;

  const dir=new THREE.Vector3(0,0,-1).applyQuaternion(car.quaternion);
  const next=car.position.clone().addScaledVector(dir,carSpeed);

  let blocked=collide(vehicleBox(next));
  police.forEach(p=>{
   if(vehicleBox(next).intersectsBox(vehicleBox(p.position))){
    blocked=true;
    stars=Math.min(5,stars+0.3);
    carHealth-=10;
   }
  });

  if(!blocked){
   car.position.copy(next);
  }else{
   carSpeed*=-0.3;
   carHealth-=Math.abs(carSpeed)*50;
  }

  carHealth=Math.max(0,carHealth);
  car.material.color.setHSL(0,carHealth/100,0.5);
  if(carHealth<=0)carSpeed=0;

  player.position.copy(car.position);
 }

 // --- POLIC√çA ---
 if(stars>0){
  police.forEach(p=>{
   const dir=player.position.clone().sub(p.position).normalize();
   p.position.addScaledVector(dir,0.05);
   if(!inCar&&vehicleBox(p.position).intersectsBox(playerBox(player.position))){
    playerVel.multiplyScalar(-0.3);
    stars=Math.min(5,stars+0.1);
   }
  });
 }

 // --- HUD ---
 if(inCar){
  document.getElementById('hud').innerHTML=
   `‚≠ê Estrellas: ${Math.floor(stars)}<br>üöó Vida coche: ${Math.floor(carHealth)}`;
 }else{
  document.getElementById('hud').innerHTML=
   `‚≠ê Estrellas: ${Math.floor(stars)}<br>Click para c√°mara ¬∑ WASD mover ¬∑ E coche ¬∑ Q salir`;
 }

 // --- C√ÅMARA ---
 const target=inCar?car.position:player.position;
 const distance=inCar?12:10;
 const height=inCar?5:6;
 const camOffset=new THREE.Vector3(
  Math.sin(yaw)*distance,
  height+pitch*3,
  Math.cos(yaw)*distance
 );
 camera.position.copy(target).add(camOffset);
 camera.lookAt(target);

 renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
