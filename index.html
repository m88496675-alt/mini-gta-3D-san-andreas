<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mini GTA 3D ‚Äì Base Estable</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000}
#hud{position:fixed;top:10px;left:10px;color:#fff;font-family:Arial;background:rgba(0,0,0,.6);padding:8px;border-radius:6px;font-size:14px;z-index:10}
</style>
</head>
<body>
<div id="hud">Click para empezar</div>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>
<script>
// =================== SEGURIDAD B√ÅSICA ===================
try{

// =================== ESCENA ===================
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

window.addEventListener('resize',()=>{
 camera.aspect = window.innerWidth/window.innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(window.innerWidth, window.innerHeight);
});

// =================== LUCES ===================
scene.add(new THREE.AmbientLight(0xffffff,0.7));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(10,20,10);
scene.add(sun);

// =================== SUELO ===================
const floor = new THREE.Mesh(
 new THREE.PlaneGeometry(400,400),
 new THREE.MeshStandardMaterial({color:0x3a8f3a})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

// =================== EDIFICIOS ===================
const buildings = [];
for(let i=0;i<20;i++){
 const h = 5 + Math.random()*20;
 const b = new THREE.Mesh(
  new THREE.BoxGeometry(6,h,6),
  new THREE.MeshStandardMaterial({color:0x777777})
 );
 b.position.set((Math.random()-.5)*150, h/2, (Math.random()-.5)*150);
 scene.add(b);
 buildings.push(b);
}

// =================== JUGADOR ===================
const player = new THREE.Mesh(
 new THREE.BoxGeometry(1,2,1),
 new THREE.MeshStandardMaterial({color:0x0077ff})
);
player.position.set(0,1,0);
scene.add(player);

// =================== COCHE ===================
const car = new THREE.Mesh(
 new THREE.BoxGeometry(2,1,4),
 new THREE.MeshStandardMaterial({color:0xff0000})
);
car.position.set(5,0.5,5);
scene.add(car);

let carSpeed = 0;
let carHealth = 100;
let carDestroyed = false;
let stars = 0;

// =================== CONTROLES ===================
const keys = {};
window.addEventListener('keydown',e=>keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()] = false);

let yaw = Math.PI;
let inCar = false;

renderer.domElement.addEventListener('click',()=>{
 renderer.domElement.requestPointerLock();
});

document.addEventListener('mousemove',e=>{
 if(document.pointerLockElement !== renderer.domElement) return;
 yaw -= e.movementX * 0.002;
});

// =================== COLISI√ìN SIMPLE ===================
function hit(obj,next){
 const box = new THREE.Box3().setFromObject(obj);
 const delta = next.clone().sub(obj.position);
 box.min.add(delta); box.max.add(delta);
 for(const b of buildings){
  if(box.intersectsBox(new THREE.Box3().setFromObject(b))) return true;
 }
 return false;
}

// =================== LOOP ===================
function animate(){
 requestAnimationFrame(animate);

 // JUGADOR
 if(!inCar){
  const dir = new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
  let next = player.position.clone();
  if(keys.w) next.add(dir.multiplyScalar(0.15));
  if(keys.s) next.add(dir.multiplyScalar(-0.15));
  if(!hit(player,next)) player.position.copy(next);
  if(keys.e && player.position.distanceTo(car.position)<3 && !carDestroyed){ inCar=true; }
 }

 // COCHE
 if(inCar && !carDestroyed){
  if(keys.w) carSpeed += 0.03;
  if(keys.s) carSpeed -= 0.03;
  carSpeed *= 0.96;
  car.rotation.y = yaw;
  const dir = new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
  const next = car.position.clone().add(dir.multiplyScalar(carSpeed));
  if(!hit(car,next)){
   car.position.copy(next);
  }else{
   carSpeed = 0;
   carHealth -= 25;
   stars = Math.min(5, stars + 1);
   car.material.color.setHSL(0,Math.max(0,carHealth/100),0.5);
   if(carHealth<=0){ carDestroyed=true; }
  }
  player.position.copy(car.position);
  if(keys.q) inCar=false;
 }

 if(inCar && carDestroyed){
  inCar = false;
  player.position.set(car.position.x+2,1,car.position.z);
 }
 }

 // C√ÅMARA
 const target = inCar ? car : player;
 camera.position.set(
  target.position.x + Math.sin(yaw)*10,
  target.position.y + 6,
  target.position.z + Math.cos(yaw)*10
 );
 camera.lookAt(target.position);

 // HUD
 const hud = document.getElementById('hud');
 if(carDestroyed){
   hud.innerHTML = `üí• Coche destruido<br>‚≠ê Estrellas: ${stars}`;
  }else if(inCar){
   hud.innerHTML = `üöó Vida: ${carHealth}<br>‚≠ê Estrellas: ${stars}`;
  }else{
   hud.innerHTML = `WASD mover ¬∑ E coche<br>‚≠ê Estrellas: ${stars}`;
  }

 renderer.render(scene,camera);
}

animate();

}catch(e){
 document.body.innerHTML = '<pre style="color:red">ERROR:\n'+e+'</pre>';
 console.error(e);
}
</script>
</body>
</html>
