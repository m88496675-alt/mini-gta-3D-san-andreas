<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mini GTA 3D</title>
<style>
body{margin:0;overflow:hidden;background:#000}
#hud{position:fixed;top:10px;left:10px;color:white;font-family:Arial;background:rgba(0,0,0,.5);padding:8px;border-radius:6px;font-size:14px}
</style>
</head>
<body>
<div id="hud"></div>
<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>
<script>
// =================== ESCENA ===================
const scene=new THREE.Scene();scene.background=new THREE.Color(0x87ceeb);
const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);document.body.appendChild(renderer.domElement);
window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)});

// =================== LUCES ===================
scene.add(new THREE.AmbientLight(0xffffff,.6));
const sun=new THREE.DirectionalLight(0xffffff,1);sun.position.set(10,20,10);scene.add(sun);

// =================== SUELO ===================
const floor=new THREE.Mesh(new THREE.PlaneGeometry(500,500),new THREE.MeshStandardMaterial({color:0x3a8f3a}));
floor.rotation.x=-Math.PI/2;scene.add(floor);

// =================== EDIFICIOS ===================
const buildings=[];
for(let i=0;i<40;i++){
 const w=5+Math.random()*10,h=5+Math.random()*30,d=5+Math.random()*10;
 const b=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshStandardMaterial({color:0x6b8e23}));
 b.position.set((Math.random()-.5)*200,h/2,(Math.random()-.5)*200);
 scene.add(b);buildings.push(b);
}

// =================== JUGADOR ===================
const player=new THREE.Mesh(new THREE.CapsuleGeometry(.5,1.5,4,8),new THREE.MeshStandardMaterial({color:0x0077ff}));
player.position.set(0,1,0);scene.add(player);
let velocity=new THREE.Vector3();

// =================== COCHE ===================
const car=new THREE.Mesh(new THREE.BoxGeometry(2,1,4),new THREE.MeshStandardMaterial({color:0xff0000}));
car.position.set(5,.5,5);scene.add(car);
let carSpeed=0,carHealth=100;
let carDestroyed=false;

// =================== POLICIA ===================
const cops=[];let stars=0;
for(let i=0;i<3;i++){
 const c=new THREE.Mesh(new THREE.BoxGeometry(2,1,4),new THREE.MeshStandardMaterial({color:0x0000ff}));
 c.position.set((Math.random()-.5)*100,.5,(Math.random()-.5)*100);
 scene.add(c);cops.push(c);
}

// =================== CONTROLES ===================
const keys={};onkeydown=e=>keys[e.key.toLowerCase()]=true;onkeyup=e=>keys[e.key.toLowerCase()]=false;
let yaw=Math.PI,pitch=0,inCar=false;
renderer.domElement.onclick=()=>renderer.domElement.requestPointerLock();
document.addEventListener('mousemove',e=>{
 if(document.pointerLockElement!==renderer.domElement)return;
 yaw-=e.movementX*0.002;pitch-=e.movementY*0.002;pitch=Math.max(-1,Math.min(1,pitch));
});

// =================== COLISION ===================
function collide(obj,next){
 const box=new THREE.Box3().setFromObject(obj);
 const delta=next.clone().sub(obj.position);
 box.min.add(delta);box.max.add(delta);
 for(const b of buildings){if(box.intersectsBox(new THREE.Box3().setFromObject(b)))return true}
 for(const c of cops){if(obj!==c && box.intersectsBox(new THREE.Box3().setFromObject(c)))return true}
 return false;
}

// =================== LOOP ===================
function animate(){requestAnimationFrame(animate);
 if(!isFinite(yaw)){yaw=Math.PI;pitch=0}

 // JUGADOR
 if(!inCar){
  const dir=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
  if(keys.w)velocity.add(dir.multiplyScalar(.05));
  if(keys.s)velocity.add(dir.multiplyScalar(-.05));
  const next=player.position.clone().add(velocity);
  if(!collide(player,next))player.position.copy(next); else velocity.multiplyScalar(-.2);
  velocity.multiplyScalar(.85);
  if(keys.e&&player.position.distanceTo(car.position)<3)inCar=true;
 }

 // COCHE
 if(inCar && !carDestroyed){
  if(keys.w)carSpeed+=.02;if(keys.s)carSpeed-=.02;carSpeed*=.98;
  car.rotation.y=yaw;
  const dir=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
  const next=car.position.clone().add(dir.multiplyScalar(carSpeed));
  if(!collide(car,next))car.position.copy(next);
  else{
   carSpeed*=-.3;
   carHealth-=15;
   car.material.color.setHSL(0,Math.max(0,carHealth/100),.5);
   if(carHealth<=0){carDestroyed=true;carSpeed=0;}
  }
  player.position.copy(car.position);
  if(keys.q)inCar=false;
 }

 if(carDestroyed){
  carSpeed=0;
 }

 // POLICIA
 cops.forEach(c=>{
  if(stars>0){
   const dir=player.position.clone().sub(c.position).normalize();
   c.position.add(dir.multiplyScalar(.05));
   if(c.position.distanceTo(player.position)<2)stars=Math.max(0,stars-.01);
  }
 });

 // CAMARA
 const target=inCar?car:player;
 const dist=inCar?12:10;
 camera.position.copy(target.position).add(new THREE.Vector3(Math.sin(yaw)*dist,6,Math.cos(yaw)*dist));
 camera.lookAt(target.position);

 // HUD
 document.getElementById('hud').innerHTML=
 carDestroyed
 ? 'ðŸ’¥ Coche destruido Â· Q salir'
 : `â­ Estrellas: ${Math.floor(stars)}<br>${inCar?`ðŸš— Vida: ${Math.max(0,Math.floor(carHealth))}`:'WASD mover Â· E coche Â· Q salir'}`;
